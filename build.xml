<project name="whiley" default="build-all">  
  <property name="version" value="0.3.16"/>

  <!-- Build Commands -->

  <target name="compile-all">
    <subant failonerror="true" target="compile">
      <property name="version" value="${version}"/>
      <fileset dir="modules" includes="*/build.xml"/>
    </subant>
  </target>

  <target name="build-all">
    <subant failonerror="true" target="build">
      <property name="version" value="${version}"/>
      <fileset dir="modules" includes="*/build.xml"/>
    </subant>
  </target>
 
  <target name="stdlib" depends="build-all">
    <taskdef name="wyjc" classname="wyjc.util.AntTask" classpath="src/"/>
    <javac debug="true" srcdir="stdlib" includeantruntime="false" includes="whiley/**/*.java" classpath="lib/wyjc.jar"/> 
    <wyjc verbose="false" srcdir="stdlib" includes="whiley/**/*.whiley"/>

    <jar destfile="lib/wyrt.jar">
      <fileset dir="src" includes="wyjc/runtime/**/*.class,wyjc/io/JavaIdentifierInputStream.class,wyjvm/io/BinaryInputStream.class"/>
      <fileset dir="stdlib" includes="whiley/**/*.class"/>
      <fileset dir="stdlib" includes="whiley/**/*.wyil"/>
    </jar>
  </target>

  <target name="clean">
    <subant failonerror="false" target="clean">
      <fileset dir="modules" includes="*/build.xml"/>
    </subant>
    <delete includeEmptyDirs="true" failonerror="false">
      <fileset file="*~"/>
    </delete>
  </target>
 

  <!-- Distributions -->
 
  <target name="distjar">
    <mkdir dir="tmp"/>
    <manifest file="tmp/MANIFEST.MF">
      <attribute name="Built-By" value="${user.name}"/>
      <attribute name="Main-Class" value="wyjc.Main"/>
      <attribute name="Implementation-Version" value="${version}-${build.number}"/>
      <attribute name="Implementation-Title" value="wyjc-v${version}.jar"/>
    </manifest>
    <jar destfile="wyjc-v${version}.jar" manifest="tmp/MANIFEST.MF">
      <fileset dir="src">
	<include name="wyautl/**/*.class"/>
	<include name="wybs/**/*.class"/>
	<include name="wyc/**/*.class"/>
	<include name="wyjc/**/*.class"/>
	<include name="wyil/**/*.class"/>
	<include name="wyjvm/**/*.class"/>
	<include name="wyone/**/*.class"/>
      </fileset>
      <fileset dir="stdlib" includes="whiley/**/*.class"/>
    </jar>
    <delete dir="tmp"/>
  </target>

  <target name="distsrc">
  <mkdir dir="wdk-v${version}"/>
  <copy todir="wdk-v${version}">
    <fileset dir=".">
      <include name="src/wyautl/**/*.java"/>
      <include name="src/wybs/**/*.java"/>
      <include name="src/wyc/**/*.java"/>
      <include name="src/wyjc/**/*.java"/>
      <include name="src/wyil/**/*.java"/>
      <include name="src/wyjvm/**/*.java"/>
      <include name="src/wyone/**/*.java"/>
    </fileset>
    <fileset dir="." includes="tests/**/*.whiley,tests/**/*.sysout"/>
    <fileset dir="." includes="examples/**/*.whiley"/>
    <fileset dir="." includes="stdlib/**/*.whiley"/>
    <fileset dir="." includes="stdlib/**/*.java"/>
    <fileset dir=".">
      <include name="bin/wyjc"/>
      <include name="bin/whiley"/>
    </fileset>
    <fileset dir="." includes="LICENSE,README,build.xml"/>
    <fileset dir="." includes="lib/wyrt.jar,lib/wyjc.jar"/>
  </copy>
  <tar destfile="wdk-src-v${version}.tar" longfile="gnu">  
    <tarfileset dir="." includes="wdk-v${version}/**/*.java"/>
    <tarfileset dir="." includes="wdk-v${version}/**/*.whiley"/>
    <tarfileset dir="." includes="wdk-v${version}/**/*.sysout"/>
    <tarfileset dir="." filemode="755">
      <include name="wdk-v${version}/bin/wyjc"/>
      <include name="wdk-v${version}/bin/whiley"/>
    </tarfileset>
    <tarfileset dir="." includes="wdk-v${version}/LICENSE,wdk-v${version}/README,wdk-v${version}/build.xml"/>
    <tarfileset dir="." includes="wdk-v${version}/lib/wyrt.jar,wdk-v${version}/lib/wyjc.jar"/>
  </tar>
  <gzip destfile="wdk-src-v${version}.tgz" src="wdk-src-v${version}.tar"/>
  <delete file="wdk-src-v${version}.tar"/>
  <delete dir="wdk-v${version}"/>
  </target>

  <target name="dist" depends="distsrc,distjar">
  </target>

</project>
